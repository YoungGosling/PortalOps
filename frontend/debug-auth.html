<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PortalOps è®¤è¯è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2563eb;
      margin-top: 0;
    }
    h2 {
      color: #334155;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status.success {
      background: #dcfce7;
      color: #166534;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .status.warning {
      background: #fef3c7;
      color: #92400e;
    }
    .info {
      background: #f8fafc;
      border-left: 4px solid #2563eb;
      padding: 12px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button.danger {
      background: #dc2626;
    }
    button.danger:hover {
      background: #b91c1c;
    }
    .action-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ” PortalOps è®¤è¯è¯Šæ–­å·¥å…·</h1>
    <p>æ­¤å·¥å…·å¸®åŠ©æ‚¨è¯Šæ–­å’Œä¿®å¤è®¤è¯ç›¸å…³çš„é—®é¢˜</p>
  </div>

  <div class="card">
    <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>ğŸ” è¯¦ç»†ä¿¡æ¯</h2>
    <div id="details"></div>
  </div>

  <div class="card">
    <h2>ğŸ› ï¸ æ“ä½œ</h2>
    <div class="action-section">
      <button onclick="checkStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
      <button onclick="testApiRequest()">ğŸ§ª æµ‹è¯• API è¯·æ±‚</button>
      <button onclick="clearAuth()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®</button>
    </div>
  </div>

  <div class="card" id="test-result" style="display: none;">
    <h2>ğŸ§ª API æµ‹è¯•ç»“æœ</h2>
    <div id="test-output"></div>
  </div>

  <script>
    function checkStatus() {
      const statusDiv = document.getElementById('status')
      const detailsDiv = document.getElementById('details')
      
      // Check localStorage
      const token = localStorage.getItem('portalops_token')
      const userStr = localStorage.getItem('portalops_user')
      const user = userStr ? JSON.parse(userStr) : null
      
      // Check cookies
      const cookies = document.cookie
      const hasAuthCookie = cookies.includes('auth_token')
      
      // Build status HTML
      let statusHtml = '<div>'
      
      if (token) {
        statusHtml += '<p>âœ… Token å­˜åœ¨ <span class="status success">æ­£å¸¸</span></p>'
      } else {
        statusHtml += '<p>âŒ Token ä¸å­˜åœ¨ <span class="status error">é”™è¯¯</span></p>'
      }
      
      if (user) {
        statusHtml += '<p>âœ… ç”¨æˆ·æ•°æ®å­˜åœ¨ <span class="status success">æ­£å¸¸</span></p>'
      } else {
        statusHtml += '<p>âŒ ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨ <span class="status error">é”™è¯¯</span></p>'
      }
      
      if (hasAuthCookie) {
        statusHtml += '<p>âœ… è®¤è¯ Cookie å­˜åœ¨ <span class="status success">æ­£å¸¸</span></p>'
      } else {
        statusHtml += '<p>âš ï¸ è®¤è¯ Cookie ä¸å­˜åœ¨ <span class="status warning">è­¦å‘Š</span></p>'
      }
      
      statusHtml += '</div>'
      statusDiv.innerHTML = statusHtml
      
      // Build details HTML
      let detailsHtml = ''
      
      if (token) {
        detailsHtml += '<h3>ğŸ”‘ Token</h3>'
        detailsHtml += `<div class="info">${token.substring(0, 50)}...${token.substring(token.length - 20)}</div>`
        
        // Try to decode JWT
        try {
          const parts = token.split('.')
          if (parts.length === 3) {
            const payload = JSON.parse(atob(parts[1]))
            detailsHtml += '<h4>Token Payload:</h4>'
            detailsHtml += `<pre>${JSON.stringify(payload, null, 2)}</pre>`
            
            // Check expiration
            if (payload.exp) {
              const expDate = new Date(payload.exp * 1000)
              const now = new Date()
              const isExpired = expDate < now
              
              detailsHtml += '<p><strong>è¿‡æœŸæ—¶é—´:</strong> ' + expDate.toLocaleString('zh-CN')
              if (isExpired) {
                detailsHtml += ' <span class="status error">å·²è¿‡æœŸ</span></p>'
              } else {
                detailsHtml += ' <span class="status success">æœ‰æ•ˆ</span></p>'
              }
            }
          }
        } catch (e) {
          detailsHtml += '<p class="status error">âš ï¸ Token è§£æå¤±è´¥</p>'
        }
      }
      
      if (user) {
        detailsHtml += '<h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>'
        detailsHtml += `<pre>${JSON.stringify(user, null, 2)}</pre>`
      }
      
      if (hasAuthCookie) {
        detailsHtml += '<h3>ğŸª Cookies</h3>'
        detailsHtml += `<div class="info">${cookies}</div>`
      }
      
      if (!token && !user) {
        detailsHtml += '<div class="info" style="background: #fee2e2; border-left-color: #dc2626;">'
        detailsHtml += '<strong>âŒ æœªç™»å½•</strong><br>'
        detailsHtml += 'è¯·å…ˆè®¿é—® <a href="http://localhost:3000/signin" target="_blank">http://localhost:3000/signin</a> ç™»å½•'
        detailsHtml += '</div>'
      }
      
      detailsDiv.innerHTML = detailsHtml
    }
    
    async function testApiRequest() {
      const token = localStorage.getItem('portalops_token')
      const testResultDiv = document.getElementById('test-result')
      const testOutputDiv = document.getElementById('test-output')
      
      testResultDiv.style.display = 'block'
      testOutputDiv.innerHTML = '<p>â³ æ­£åœ¨æµ‹è¯•...</p>'
      
      if (!token) {
        testOutputDiv.innerHTML = '<p class="status error">âŒ æ²¡æœ‰ tokenï¼Œæ— æ³•æµ‹è¯•</p>'
        return
      }
      
      try {
        const response = await fetch('http://127.0.0.1:8000/api/services', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        
        const data = await response.json()
        
        let html = '<h3>è¯·æ±‚ç»“æœ</h3>'
        html += `<p><strong>çŠ¶æ€ç :</strong> ${response.status} ${response.statusText}`
        
        if (response.ok) {
          html += ' <span class="status success">æˆåŠŸ</span></p>'
          html += '<h4>å“åº”æ•°æ®:</h4>'
          html += `<pre>${JSON.stringify(data, null, 2)}</pre>`
        } else {
          html += ' <span class="status error">å¤±è´¥</span></p>'
          html += '<h4>é”™è¯¯ä¿¡æ¯:</h4>'
          html += `<pre>${JSON.stringify(data, null, 2)}</pre>`
          
          if (response.status === 403) {
            html += '<div class="info" style="background: #fee2e2; border-left-color: #dc2626;">'
            html += '<strong>ğŸ”´ 403 Forbidden</strong><br>'
            html += 'è¿™æ„å‘³ç€ï¼š<br>'
            html += '1. Token æ— æ•ˆæˆ–å·²è¿‡æœŸ<br>'
            html += '2. åç«¯æ— æ³•éªŒè¯ token<br>'
            html += '3. ç”¨æˆ·æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æº<br><br>'
            html += '<strong>å»ºè®®æ“ä½œï¼š</strong><br>'
            html += '1. æ¸…é™¤è®¤è¯æ•°æ®å¹¶é‡æ–°ç™»å½•<br>'
            html += '2. æ£€æŸ¥åç«¯æ—¥å¿—<br>'
            html += '3. ç¡®è®¤ JWT å¯†é’¥é…ç½®æ­£ç¡®'
            html += '</div>'
          }
        }
        
        testOutputDiv.innerHTML = html
      } catch (error) {
        let html = '<p class="status error">âŒ è¯·æ±‚å¤±è´¥</p>'
        html += `<div class="info" style="background: #fee2e2; border-left-color: #dc2626;">`
        html += `<strong>é”™è¯¯:</strong> ${error.message}<br><br>`
        html += '<strong>å¯èƒ½åŸå› ï¼š</strong><br>'
        html += '1. åç«¯æœåŠ¡æœªå¯åŠ¨<br>'
        html += '2. CORS é…ç½®é—®é¢˜<br>'
        html += '3. ç½‘ç»œè¿æ¥é—®é¢˜'
        html += '</div>'
        testOutputDiv.innerHTML = html
      }
    }
    
    function clearAuth() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®å—ï¼Ÿè¿™å°†ç™»å‡ºæ‚¨çš„è´¦å·ã€‚')) {
        return
      }
      
      localStorage.removeItem('portalops_token')
      localStorage.removeItem('portalops_user')
      document.cookie = 'auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
      
      alert('âœ… è®¤è¯æ•°æ®å·²æ¸…é™¤ï¼è¯·é‡æ–°ç™»å½•ã€‚')
      checkStatus()
    }
    
    // Initial check
    checkStatus()
  </script>
</body>
</html>

